@page
@model SailingWeb.Pages.ManageRaceModel
@{
    ViewData["Title"] = "ManageRace";
}

<h2>ManageRace</h2>

<html>
<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>

        table, th, td {
            border: 1px solid black;
            padding: 5px;
            width: 200px;
            overflow: auto;
            overflow-y: visible;
        }
    </style>
</head>
<body onload="onload()">

    @if (ManageRaceModel.RaceNameStatic == null)
    {
        <form method="POST">
            <select id="select" class="form-control" asp-for="RaceName">
                @foreach (Calendar race in Program.Globals.Todaysevents)
                {
                    <option value="@string.Concat(race.Summary, "abc123", race.DateTime)">@race.Summary, @race.DateTime.TimeOfDay</option>
                }
            </select>
            <input type="submit" />
        </form>
    }
    else
    {<div id="table-wrapper">
            <table id="table1">
                <tr>
                    <th>Helm</th>
                    <th>Crew</th>
                    <th>Boat Name</th>
                    <th>Boat Number</th>
                    <th>Lap</th>
                    <th>Py</th>
                    <th>Notes</th>
                    <th>Place</th>
                    @for (int i = 1; i < (ManageRaceModel.NoOfLaps + 1); i++)
                    {
                        <th>@String.Concat("Lap ", i)</th>
                    }
                </tr>
                @foreach (KeyValuePair<Data.BoatsTidy, List<Data.BoatLap>> key in ManageRaceModel.Race.Item2)
                {
                <tr>
                    <td>@key.Key.Name</td>
                    <td>@key.Key.Crew</td>
                    <td>@key.Key.Boat</td>
                    <td>@key.Key.BoatNumber</td>
                    <td>
                        <button class="btn" onclick="
                                newlap(@Html.Raw(Json.Serialize(key.Key)).ToString(), @key.Value.Count);">
                            Lap
                        </button>

                    </td>
                    <td>@key.Key.Py</td>
                    <td>@key.Key.Notes</td>

                    @try
                    {
                        <td>
                            0
                            <!--ManageRaceModel.Race.Item2.OrderBy(x => x.Value.OrderBy(y => y.LapNumber).LastOrDefault().LapTime).ToList().IndexOf(key);-->
                        </td>
                    }
                    catch
                    {
                        <td><p>Error!</p></td>
                    }


                    @for (int i = 1; i < (key.Value.Count + 1); i++)
                    {
                        try
                        {
                            <td onclick="editLap(@Html.Raw(Json.Serialize(key.Key)).ToString(), @i, '@key.Value.Where(x => x.LapNumber.Equals(i)).FirstOrDefault().LapTime');">@key.Value.Where(x => x.LapNumber.Equals(i)).FirstOrDefault().LapTime.ToString(@"hh\:mm\:ss\:ff")
                    </td>
                        }
                        catch
                        {
                            <td><p>Error!</p></td>

                        }
                    }


                </tr>
                }
            </table>
        </div>

    }
    <form id="submit" method="get"></form>
    <form id="submit1" method="post">
        <button style="visibility:collapse" id="startracebutton" onclick="startrace()">Click to start race.</button>
    </form>

    <p id="demo"></p>
    <div style="display:none" id="dialog-form" title="Edit data.">
        <form>
            <fieldset>
                <label for="password">Change time</label>
                <input name="password" id="password" value="xxxxxxx" class="text ui-widget-content ui-corner-all">

                <!-- Allow form submission with keyboard without duplicating the dialog button -->
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>
    <div id="dialog" title="Dialog Title" style="display:none">I'm a dialog</div>

    <script>
        $("#dialog").dialog({ autoOpen: false });
        $("#opener").click(function () {
            $("#dialog").dialog("open");
        });
    </script>
    <script src="~/js/countup_timer.min.js"></script>
    <script>
        function editLap(username, lapNo, time) {
            document.getElementById("dialog-form").title = "Edit time for ".concat(username.name).concat(" on lap ").concat(lapNo.toString());
            document.getElementById("password").value = time;
            document.getElementById("dialog-form").style.display ="inline";
            $("#dialog-form").dialog({
                autoOpen: false,
                buttons: {
                    "Remove Lap": function () {
                        $.ajax({
                            url: "/Folder/RemoveTime",
                            data: {
                                name: JSON.stringify(username), lapNumber: lapNo
                            },
                            headers: {
                                RequestVerificationToken:
                                    $('input:hidden[name="__RequestVerificationToken"]').val()
                            },
                            success: function (data) {
                                document.getElementById("submit").submit();
                            }

                        });
                    },
                    "Enter": function () {
                        $.ajax({
                            url: "/Folder/UpdateTime",
                            data: {
                                name: JSON.stringify(username), lapNumber: lapNo, lapTime: document.getElementById("password").value
                            },
                            headers: {
                                RequestVerificationToken:
                                    $('input:hidden[name="__RequestVerificationToken"]').val()
                            },
                            success: function (data) {
                                document.getElementById("submit").submit();
                            }

                        });
                    },
                    Cancel: function () {
                        $("#dialog-form").dialog("close");
                    }
                },
                close: function () {
                }});
            $("#dialog-form").dialog("open");
            /*
                .dialog({
                autoOpen: true,
                height: 400,
                width: 350,
                modal: true,
                buttons: {
                    "Create an account": function () {
                        $.ajax({
                            url: "/Folder/UpdateTime",
                            data: {
                                name: JSON.stringify(username), lapNumber: lapNo, lapTime: time
                            },
                            headers: {
                                RequestVerificationToken:
                                    $('input:hidden[name="__RequestVerificationToken"]').val()
                            },
                            success: function (data) {
                                document.getElementById("submit").submit();
                            }

                        });
                    },
                    Cancel: function () {
                        dialog.dialog("close");
                    }
                },
                close: function () {
                }
            });
            */
        }
        function newlap(boatin, lapno) {
            var lap = lapno + 1;
            $.ajax({
                url: "/Folder/NewLap",
                data: { boat: JSON.stringify(boatin), lapTime: new Date().toJSON(), lapNumber: lap },
                headers: {
                    RequestVerificationToken:
                        $('input:hidden[name="__RequestVerificationToken"]').val()
                },
                success: function (data) {
                    document.getElementById("submit").submit();
                }

            });
        }

        function myTimer(resulting) {

            console.log("Repeating function invoked.");

            var e = resulting;
            var d = new Date();
            x = d.getTime();
            f = x - e;

            // Create a new JavaScript Date object based on the timestamp
            // multiplied by 1000 so that the argument is in milliseconds, not seconds.
            var date = new Date(f);
            // Hours part from the timestamp
            var hours = date.getHours();
            // Minutes part from the timestamp
            var minutes = "0" + date.getMinutes();
            // Seconds part from the timestamp
            var seconds = "0" + date.getSeconds();


            var milliseconds = "0" + date.getMilliseconds();
            // Will display time in 10:30:23 format

            var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
            new CountUpTimer(formattedTime, function (times, parameters) {
                document.getElementById("demo").innerHTML = times;

            });


        }
        //var time;
        function onload() {
            $.ajax({
                url: "/Folder/GetStartTime",
                headers: {
                    RequestVerificationToken:
                        $('input:hidden[name="__RequestVerificationToken"]').val()
                },
                success: function (resulting) {
                    if (resulting > 0) {
                        console.log("Set repeating function");
                        myTimer(resulting);
                    }
                    else {
                        document.getElementById("startracebutton").style.visibility = "visible";

                    }


                }
            });

        }
        function startrace() {


            $.ajax({
                url: "/Folder/StartRace",
                headers: {
                    RequestVerificationToken:
                        $('input:hidden[name="__RequestVerificationToken"]').val()
                },
                success: function (data) {
                    document.getElementById("submit1").submit();
                }

            });

        }
    </script>

        <!--<p onclick="document.getElementById('submit1').submit();">There was an error, try refreshing?</p>-->

    
</body>

</html>